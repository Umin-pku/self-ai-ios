<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Self–AI Task</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;

      --selfFill: rgba(59,130,246,.45);
      --selfStroke: rgba(59,130,246,.95);
      --aiFill: rgba(16,185,129,.35);
      --aiStroke: rgba(16,185,129,.85);

      --hl:#facc15; /* yellow highlight */
      --radiusMin: 40;
      --radiusMax: 220;
      --radiusInit: 100;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: var(--bg);
      color: var(--text);
    }
    .wrap{
      max-width: 980px;
      margin: 18px auto;
      padding: 12px;
    }
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 6px 20px rgba(0,0,0,.05);
    }
    h1{
      font-size: 22px;
      margin: 0 0 8px 0;
      font-weight: 800;
    }
    .desc{
      font-size: 14px;
      line-height: 1.5;
      color: var(--muted);
      margin: 0 0 14px 0;
    }
    .hl{
      font-weight: 800;
      background: var(--hl);
      padding: 0 4px;
      border-radius: 4px;
      color: #111827;
    }

    .canvasWrap{
      border: 1px solid var(--border);
      border-radius: 14px;
      background: #fff;
      padding: 10px;
    }
    .canvas{
      width: 100%;
      height: 360px;
      border-radius: 12px;
      background: #ffffff;
      position: relative;
      overflow: hidden;
    }

    .circle{
      position:absolute;
      border-radius: 9999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 800;
      font-size: 24px;
      color:#ffffff;
      user-select: none;
      touch-action: none;
      cursor: grab;
    }
    .circle:active{ cursor: grabbing; }

    .self{
      background: var(--selfFill);
      border: 4px solid var(--selfStroke);
      text-shadow: 0 1px 1px rgba(0,0,0,.15);
    }
    .ai{
      background: var(--aiFill);
      border: 4px solid var(--aiStroke);
      text-shadow: 0 1px 1px rgba(0,0,0,.15);
    }

    .controls{
      margin-top: 14px;
      border-top: 1px solid var(--border);
      padding-top: 14px;
    }
    .row{
      display:flex;
      gap: 12px;
      align-items:center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .tag{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 86px;
      color: var(--text);
      font-size: 14px;
      font-weight: 700;
    }
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 9999px;
    }
    .dotSelf{ background: var(--selfStroke); }
    .dotAI{ background: var(--aiStroke); }
    input[type="range"]{
      flex: 1 1 240px;
      min-width: 220px;
    }

    .field{
      width: 100%;
      display:flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 8px;
    }
    .label{
      font-size: 14px;
      font-weight: 800;
      color: var(--text);
    }
    .input{
      width: 100%;
      max-width: 100%;
      padding: 12px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      background: #fff;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
    }

    .actions{
      display:flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .btn{
      border: none;
      border-radius: 12px;
      padding: 12px 18px;
      font-weight: 800;
      font-size: 15px;
      cursor: pointer;
    }
    .btnPrimary{
      background: #10b981;
      color: #fff;
    }
    .btnGhost{
      background: #111827;
      color: #fff;
    }
    .err{
      margin-top: 10px;
      font-size: 13px;
      color: #b91c1c;
      font-weight: 700;
      display:none;
    }

    #endScreen{
      display:none;
      text-align:center;
      padding: 26px 10px 10px;
    }
    #endScreen .t1{
      font-size: 18px;
      font-weight: 900;
      margin-bottom: 8px;
    }
    #endScreen .t2{
      font-size: 14px;
      color: var(--muted);
    }

    @media (max-width: 520px){
      .canvas{ height: 300px; }
      .circle{ font-size: 20px; }
      h1{ font-size: 20px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">

      <h1>Please read the instructions carefully</h1>
      <p class="desc">
        <span class="hl">Adjust</span> the size of the two circles to represent how large you feel your <b>Self</b> and <b>AI</b> are.
        <span class="hl">Drag</span> the circles (left–right only) to represent your perceived relationship.
        More overlap means a closer relationship.
      </p>

      <div class="canvasWrap" id="taskArea">
        <div class="canvas" id="canvas">
          <div class="circle self" id="selfCircle">Self</div>
          <div class="circle ai" id="aiCircle">AI</div>
        </div>

        <div class="controls" id="controls">
          <div class="row">
            <div class="tag"><span class="dot dotSelf"></span>Self</div>
            <input id="selfRange" type="range" min="40" max="220" value="100" />
          </div>

          <div class="row">
            <div class="tag"><span class="dot dotAI"></span>AI</div>
            <input id="aiRange" type="range" min="40" max="220" value="100" />
          </div>

          <div class="field">
            <div class="label">Birth (6 digits)</div>
            <input
              id="birth"
              class="input"
              type="tel"
              inputmode="numeric"
              pattern="[0-9]{6}"
              maxlength="6"
              placeholder="e.g., 010918"
              autocomplete="off"
              required
            />
            <div class="hint">Birth is used for research purposes only.</div>
          </div>

          <div class="actions">
            <button class="btn btnPrimary" id="submitBtn">Submit</button>
            <button class="btn btnGhost" id="resetBtn" type="button">Reset</button>
          </div>

          <div class="err" id="err">Please enter your birth (6 digits).</div>
        </div>
      </div>

      <div id="endScreen">
        <div class="t1">Thank you.</div>
        <div class="t2">Please return to the questionnaire to continue.</div>
      </div>

    </div>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const selfEl = document.getElementById('selfCircle');
    const aiEl = document.getElementById('aiCircle');
    const selfRange = document.getElementById('selfRange');
    const aiRange = document.getElementById('aiRange');
    const birth = document.getElementById('birth');
    const errEl = document.getElementById('err');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');

    const endScreen = document.getElementById('endScreen');
    const taskArea = document.getElementById('taskArea');
    const controls = document.getElementById('controls');

    const state = {
      self: { r: 100, x: 0, y: 0 },
      ai:   { r: 100, x: 0, y: 0 },
      drag: { who: null, offsetX: 0 }
    };

    function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
    function clamp01(v){ return clamp(v, 0, 1); }
    function dist(x1,y1,x2,y2){ const dx=x1-x2, dy=y1-y2; return Math.sqrt(dx*dx+dy*dy); }

    function getCanvasSize(){
      const rect = canvas.getBoundingClientRect();
      return { W: rect.width, H: rect.height };
    }

    function layout(){
      const { W, H } = getCanvasSize();

      state.self.r = +selfRange.value;
      state.ai.r   = +aiRange.value;

      const fixedY = H * 0.52; // fixed vertical line (no free y dragging)
      state.self.y = fixedY;
      state.ai.y   = fixedY;

      // initialize if x not set or on resize
      if (!state.self.x || !state.ai.x){
        const gap = 40;
        state.self.x = W * 0.38;
        state.ai.x   = W * 0.62;
        // keep separated at start
        if (Math.abs(state.ai.x - state.self.x) < (state.self.r + state.ai.r + gap)){
          state.ai.x = state.self.x + (state.self.r + state.ai.r + gap);
        }
      }

      // clamp within bounds
      state.self.x = clamp(state.self.x, state.self.r, W - state.self.r);
      state.ai.x   = clamp(state.ai.x, state.ai.r, W - state.ai.r);

      render();
    }

    function render(){
      const { W, H } = getCanvasSize();

      // position circle by center
      setCircle(selfEl, state.self.x, state.self.y, state.self.r);
      setCircle(aiEl, state.ai.x, state.ai.y, state.ai.r);

      // keep y constant on resize
      state.self.y = H * 0.52;
      state.ai.y   = H * 0.52;
      setCircle(selfEl, state.self.x, state.self.y, state.self.r);
      setCircle(aiEl, state.ai.x, state.ai.y, state.ai.r);
    }

    function setCircle(el, cx, cy, r){
      el.style.width = (r*2) + 'px';
      el.style.height = (r*2) + 'px';
      el.style.left = (cx - r) + 'px';
      el.style.top  = (cy - r) + 'px';
    }

    function overlapArea(r1, r2, d){
      if (d >= r1 + r2) return 0;
      if (d <= Math.abs(r1 - r2)) {
        const r = Math.min(r1, r2);
        return Math.PI * r * r;
      }
      const a1 = 2 * Math.acos((d*d + r1*r1 - r2*r2) / (2*d*r1));
      const a2 = 2 * Math.acos((d*d + r2*r2 - r1*r1) / (2*d*r2));
      const area1 = 0.5 * r1*r1 * (a1 - Math.sin(a1));
      const area2 = 0.5 * r2*r2 * (a2 - Math.sin(a2));
      return area1 + area2;
    }

    function metrics(){
      const { W, H } = getCanvasSize();

      const rS = state.self.r;
      const rA = state.ai.r;

      const d = dist(state.self.x, state.self.y, state.ai.x, state.ai.y);

      const inter = overlapArea(rS, rA, d);
      const areaSelf = Math.PI * rS * rS;

      const overlap_ratio = clamp01(inter / areaSelf);
      const overlap_percent = Math.round(overlap_ratio * 100);
      const overlap_percent_str = `${overlap_percent}%`;

      const diag = Math.sqrt(W*W + H*H);
      const psych_distance = clamp01(d / diag); // normalized 0~1

      // normalized relative size (-1~1)
      const relative_size_norm = (rA - rS) / (rA + rS);

      return {
        overlap_percent_str,
        psych_distance,
        self_radius: rS,
        ai_radius: rA,
        relative_size_norm
      };
    }

    function showErr(msg){
      errEl.textContent = msg;
      errEl.style.display = 'block';
    }

    function clearErr(){
      errEl.style.display = 'none';
    }

    function submit(){
      const b = birth.value.trim();
      if(!/^\d{6}$/.test(b)){
        showErr('Please enter your birth (6 digits).');
        return;
      }
      clearErr();

      const out = metrics();

      // Chinese keys (Console / parent receiver)
      const payload = {
        类型: '自我AI连续IOS结果',
        时间戳: Date.now(),
        生日6位: b,
        重叠程度: out.overlap_percent_str,    // "23%"
        心理距离: out.psych_distance,         // 0~1
        自我大小: out.self_radius,            // px radius
        AI大小: out.ai_radius,                // px radius
        相对大小: out.relative_size_norm       // -1~1
      };

      window.parent.postMessage(payload, '*');

      // end screen
      taskArea.style.display = 'none';
      endScreen.style.display = 'block';
    }

    function resetAll(){
      selfRange.value = 100;
      aiRange.value = 100;
      birth.value = '';
      clearErr();

      state.self.r = 100;
      state.ai.r = 100;

      const { W, H } = getCanvasSize();
      const fixedY = H * 0.52;
      state.self.y = fixedY;
      state.ai.y = fixedY;
      state.self.x = W * 0.38;
      state.ai.x = W * 0.62;

      layout();
    }

    // Drag (left-right only)
    function onPointerDown(who, e){
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const px = e.clientX - rect.left;

      state.drag.who = who;
      const curX = who === 'self' ? state.self.x : state.ai.x;
      state.drag.offsetX = px - curX;

      (who === 'self' ? selfEl : aiEl).setPointerCapture(e.pointerId);
    }

    function onPointerMove(e){
      if(!state.drag.who) return;

      const { W } = getCanvasSize();
      const rect = canvas.getBoundingClientRect();
      const px = e.clientX - rect.left;

      if(state.drag.who === 'self'){
        const r = state.self.r;
        state.self.x = clamp(px - state.drag.offsetX, r, W - r);
      }else{
        const r = state.ai.r;
        state.ai.x = clamp(px - state.drag.offsetX, r, W - r);
      }
      render();
    }

    function onPointerUp(){
      state.drag.who = null;
    }

    selfEl.addEventListener('pointerdown', e => onPointerDown('self', e));
    aiEl.addEventListener('pointerdown', e => onPointerDown('ai', e));
    window.addEventListener('pointermove', onPointerMove);
    window.addEventListener('pointerup', onPointerUp);

    selfRange.addEventListener('input', () => layout());
    aiRange.addEventListener('input', () => layout());

    submitBtn.addEventListener('click', submit);
    resetBtn.addEventListener('click', resetAll);

    // resize
    let ro = new ResizeObserver(() => {
      // keep x within bounds after resize
      const { W } = getCanvasSize();
      state.self.x = clamp(state.self.x, state.self.r, W - state.self.r);
      state.ai.x   = clamp(state.ai.x, state.ai.r, W - state.ai.r);
      layout();
    });
    ro.observe(canvas);

    // init
    layout();
  </script>
</body>
</html>
